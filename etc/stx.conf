##
##  Capsula -- Encapsulated Command Execution
##  Copyright (c) 2025 Dr. Ralf S. Engelschall <rse@engelschall.com>
##  Licensed under MIT <https://spdx.org/licenses/MIT>
##

#   static code analysis (continuous file watching)
lint-watch
    nodemon --exec "npm start lint" --watch src --ext ts

#   static code analysis
lint
    check-dependencies && \
    eslint --config etc/eslint.mjs src/**/*.ts && \
    markdownlint-cli2 --config etc/.markdownlint.yaml src/**/*.md

#   build components for production (continuous file watching)
build-watch
    nodemon --exec "npm start build" --watch src --ext ts,1

#   build components for production
build : lint build:cmd build:man

#   build command for production
build:cmd
    vite --config etc/vite.mts build --mode production

#   build manual page for production
build:man
    shx mkdir -p dst-stage3 && \
    remark --quiet --use remark-man --output dst-stage3/capsula.1 src/capsula.md

#   build all-in-one packages
build:pkg [hostname=en4.*]
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' package.json` && \
    cd dst-stage2 && \
    shx rm -f capsula-* && \
    targets="node24-linux-x64,node24-linux-arm64"
    targets="$targets,node24-win-x64,node24-win-arm64"
    targets="$targets,node24-macos-x64,node24-macos-arm64"
    pkg --sea --public -c ../package.json -t "$targets" capsula.js && \
    shx mkdir -p ../dst-stage3 && \
    shx mv capsula-linux-x64     ../dst-stage3/capsula-lnx-x64     && \
    shx mv capsula-linux-arm64   ../dst-stage3/capsula-lnx-a64     && \
    shx mv capsula-win-x64.exe   ../dst-stage3/capsula-win-x64.exe && \
    shx mv capsula-win-arm64.exe ../dst-stage3/capsula-win-a64.exe && \
    shx mv capsula-macos-x64     ../dst-stage3/capsula-mac-x64     && \
    shx mv capsula-macos-arm64   ../dst-stage3/capsula-mac-a64

#   package distribution archives
package : build:pkg [hostname=en4.*]
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' package.json` && \
    rm -rf dst-stage4 && \
    mkdir -p dst-stage4/capsula-$VERSION/ && \
    mkdir -p dst-stage4/capsula-$VERSION-win-x64/ && \
    mkdir -p dst-stage4/capsula-$VERSION-win-a64/ && \
    mkdir -p dst-stage4/capsula-$VERSION-mac-x64/ && \
    mkdir -p dst-stage4/capsula-$VERSION-mac-a64/ && \
    mkdir -p dst-stage4/capsula-$VERSION-lnx-x64/ && \
    mkdir -p dst-stage4/capsula-$VERSION-lnx-a64/ && \
    cp -p dst-stage2/capsula.js             dst-stage4/capsula-$VERSION/capsula.js && \
    cp -p dst-stage3/capsula-win-x64.exe    dst-stage4/capsula-$VERSION-win-x64/capsula.exe && \
    cp -p dst-stage3/capsula-win-a64.exe    dst-stage4/capsula-$VERSION-win-a64/capsula.exe && \
    cp -p dst-stage3/capsula-mac-x64        dst-stage4/capsula-$VERSION-mac-x64/capsula && \
    cp -p dst-stage3/capsula-mac-a64        dst-stage4/capsula-$VERSION-mac-a64/capsula && \
    cp -p dst-stage3/capsula-lnx-x64        dst-stage4/capsula-$VERSION-lnx-x64/capsula && \
    cp -p dst-stage3/capsula-lnx-a64        dst-stage4/capsula-$VERSION-lnx-a64/capsula && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION/capsula.man && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION-win-x64/capsula.man && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION-win-a64/capsula.man && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION-mac-x64/capsula.man && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION-mac-a64/capsula.man && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION-lnx-x64/capsula.man && \
    cp -p dst-stage3/capsula.1              dst-stage4/capsula-$VERSION-lnx-a64/capsula.man && \
    cd dst-stage4 && \
    zip -9 -r capsula-$VERSION.zip         capsula-$VERSION/         && \
    zip -9 -r capsula-$VERSION-win-x64.zip capsula-$VERSION-win-x64/ && \
    zip -9 -r capsula-$VERSION-win-a64.zip capsula-$VERSION-win-a64/ && \
    zip -9 -r capsula-$VERSION-mac-x64.zip capsula-$VERSION-mac-x64/ && \
    zip -9 -r capsula-$VERSION-mac-a64.zip capsula-$VERSION-mac-a64/ && \
    zip -9 -r capsula-$VERSION-lnx-x64.zip capsula-$VERSION-lnx-x64/ && \
    zip -9 -r capsula-$VERSION-lnx-a64.zip capsula-$VERSION-lnx-a64/

#   publish distribution archives
publish : package [hostname=en4.*]
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' package.json` && \
    V=`echo "$VERSION" | sed -e 's;\.;\\.;g'` && \
    sed -n -e "/^${V} /, /^[0-9]\\./ { /^${V} /p; /^[0-9]\\./!p; }" <CHANGELOG.md >.notes.md && \
    gh release create --title "Capsula $VERSION" --notes-file .notes.md --verify-tag $VERSION \
    dst-stage4/capsula-$VERSION-win-x64.zip \
    dst-stage4/capsula-$VERSION-win-a64.zip \
    dst-stage4/capsula-$VERSION-mac-x64.zip \
    dst-stage4/capsula-$VERSION-mac-a64.zip \
    dst-stage4/capsula-$VERSION-lnx-x64.zip \
    dst-stage4/capsula-$VERSION-lnx-a64.zip && \
    rm -f .notes.md

#   development mode
dev
    chokidar "src/*" -c "npm start dev:exec"
dev:exec
    npm start build && \
    node dst-stage2/capsula.js -v id

#   remove all generated artifacts (reverse of "npm start build")
clean
    shx rm -rf dst-stage1 dst-stage2 dst-stage3

#   remove all generated artifacts (reverse of "npm install" and "npm start build")
clean:dist : clean
    shx rm -f package-lock.json && \
    shx rm -rf node_modules

